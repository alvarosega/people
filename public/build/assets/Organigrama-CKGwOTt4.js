import{r as s,a as i,j as a,H as G}from"./app-BKfOqTMF.js";import{T as H}from"./index-BLcsYpPa.js";import{A as M}from"./AuthenticatedLayout-C2R_dg5o.js";import"./transition-BC6w5YbO.js";import"./ThemeToggle-DVrhrRCS.js";const J=()=>{const C=s.useRef(null),[f,S]=s.useState([]),[W,E]=s.useState([]),[N,z]=s.useState([]),[R,k]=s.useState(!0),[n,y]=s.useState(null),[A,w]=s.useState(!1),[F,j]=s.useState(!1),[o,g]=s.useState({legajo:"",banda:"",nivel_jerarquico:0,vacante:!1}),[t,b]=s.useState({legajo:"",banda:"",nivel_jerarquico:0,vacante:!1}),[l,m]=s.useState({legajo:"",banda:"",nivel_jerarquico:1,orden:0,vacante:!0}),q=e=>{var x,h,v,p;const r=e.name??((x=e.user)==null?void 0:x.nombre)??(e.legajo?`(${e.legajo})`:"Vacante"),c=[];(h=e.user)!=null&&h.puesto&&c.push(e.user.puesto),(v=e.user)!=null&&v.territorio&&c.push(e.user.territorio),(p=e.user)!=null&&p.region&&c.push(e.user.region),e.banda&&c.push(`Banda ${e.banda}`);const u=c.join(" • ");return{name:r,title:u,id:e.id,legajo:e.legajo??null,banda:e.banda??null,nivel_jerarquico:e.nivel_jerarquico??0,orden:e.orden??0,vacante:!!e.vacante,user:e.user??null,attributes:e.attributes??{},children:(e.children||[]).map(q),__raw:e}},d=s.useCallback(async()=>{var e,r,c;k(!0);try{const u=(e=document.querySelector('meta[name="csrf-token"]'))==null?void 0:e.getAttribute("content");u&&(i.defaults.headers.common["X-CSRF-TOKEN"]=u),i.defaults.headers.common["X-Requested-With"]="XMLHttpRequest";const[x,h]=await Promise.all([i.get("/admin/organigrama/data"),i.get("/admin/organigrama/users-list")]),v=((r=x==null?void 0:x.data)==null?void 0:r.data)??[],p=v.map(q);E(v),S(p),z(((c=h==null?void 0:h.data)==null?void 0:c.data)??[])}catch(u){console.error("fetchAll error:",u),alert("Error cargando datos. Revisa consola / network.")}finally{k(!1)}},[]);s.useEffect(()=>{d()},[d]);const O=()=>{var r;return{x:(((r=C.current)==null?void 0:r.clientWidth)??800)/2,y:80}},T=async e=>{e.preventDefault();try{const r={legajo:o.legajo||null,banda:o.banda||null,nivel_jerarquico:Number(o.nivel_jerarquico||0),orden:0,parent_id:null,vacante:!!o.vacante};await i.post("/admin/organigrama",r),w(!1),g({legajo:"",banda:"",nivel_jerarquico:0,vacante:!1}),await d()}catch(r){console.error("createRoot error:",r),alert("Error creando nodo raíz. Revisa consola.")}},V=async e=>{if(e.preventDefault(),!n)return alert("No hay nodo seleccionado.");try{const r={legajo:t.vacante?null:t.legajo||null,banda:t.banda||null,nivel_jerarquico:Number(t.nivel_jerarquico||0),orden:Number(t.orden||0),vacante:!!t.vacante};await i.put(`/admin/organigrama/${n.id}`,r),y(null),j(!1),await d(),j(!1)}catch(r){console.error("updateNode error:",r),alert("Error actualizando nodo.")}},$=async()=>{if(!n)return alert("No hay nodo seleccionado.");if(confirm("¿Eliminar este nodo y todos sus hijos?"))try{await i.delete(`/admin/organigrama/${n.id}`),y(null),await d()}catch(e){console.error("deleteNode error:",e),alert("Error eliminando nodo.")}},B=async e=>{if(e.preventDefault(),!n)return alert("Selecciona un nodo padre primero.");try{const r={parent_id:n.id,legajo:l.vacante?null:l.legajo||null,banda:l.banda||null,nivel_jerarquico:Number(l.nivel_jerarquico||0),orden:Number(l.orden||0),vacante:!!l.vacante};await i.post("/admin/organigrama",r),m({legajo:"",banda:"",nivel_jerarquico:(n.nivel_jerarquico||0)+1,orden:0,vacante:!0}),await d()}catch(r){console.error("createChild error:",r),alert("Error creando hijo.")}},_=(e,r)=>{y(e),j(!0),b({legajo:e.legajo??"",banda:e.banda??"",nivel_jerarquico:e.nivel_jerarquico??0,orden:e.orden??0,vacante:!!e.vacante}),m({legajo:"",banda:"",nivel_jerarquico:(e.nivel_jerarquico??0)+1,orden:0,vacante:!0})},L=({nodeDatum:e,toggleNode:r})=>{var c;return a.jsxs("g",{onClick:u=>_(e),style:{cursor:"pointer"},children:[a.jsx("circle",{r:8,cx:-110,cy:-18,fill:e.vacante?"#ff6b6b":"#2b6cb0"}),a.jsx("foreignObject",{x:-100,y:-35,width:220,height:70,children:a.jsxs("div",{style:{border:"1px solid #ddd",borderRadius:6,padding:6,background:"#fff",boxShadow:"0 1px 2px rgba(0,0,0,0.04)",pointerEvents:"none"},children:[a.jsx("div",{style:{fontWeight:700,fontSize:13},children:e.name||"Vacante"}),a.jsx("div",{style:{fontSize:11,color:"#666"},children:e.title||(((c=e.attributes)==null?void 0:c.puesto)??"")}),a.jsx("div",{style:{fontSize:10,color:"#999",marginTop:4},children:`Nivel ${e.nivel_jerarquico??"-"} • ${e.vacante?"VACANTE":e.legajo??"-"}`})]})})]})};return R?a.jsx("div",{className:"p-6",children:"Cargando organigrama..."}):a.jsxs(M,{header:a.jsx("h2",{className:"font-semibold text-xl text-gray-800 leading-tight",children:"Organigrama"}),children:[a.jsx(G,{title:"Organigrama"}),a.jsxs("div",{className:"flex flex-col sm:flex-row h-screen",children:[a.jsx("div",{ref:C,className:"w-full h-full",children:a.jsx("div",{className:"w-full h-full flex",children:!f||f.length===0?a.jsx("div",{className:"p-6",children:A?a.jsxs("form",{onSubmit:T,className:"bg-white p-4 rounded shadow max-w-md",children:[a.jsx("h3",{className:"font-bold mb-2",children:"Crear nodo raíz"}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm",children:"Asignar usuario (opcional)"}),a.jsxs("select",{value:o.legajo,onChange:e=>g({...o,legajo:e.target.value}),className:"border rounded p-1 w-full",children:[a.jsx("option",{value:"",children:"-- Vacante --"}),N.map(e=>a.jsxs("option",{value:e.legajo,children:[e.legajo," - ",e.nombre]},e.legajo))]})]}),a.jsx("label",{className:"block text-sm",children:"Banda"}),a.jsx("input",{value:o.banda,onChange:e=>g({...o,banda:e.target.value}),className:"border p-2 rounded w-full mb-2"}),a.jsx("label",{className:"block text-sm",children:"Nivel jerárquico"}),a.jsx("input",{type:"number",value:o.nivel_jerarquico,onChange:e=>g({...o,nivel_jerarquico:Number(e.target.value)}),className:"border p-2 rounded w-full mb-2"}),a.jsxs("label",{className:"inline-flex items-center mb-3",children:[a.jsx("input",{checked:o.vacante,onChange:e=>g({...o,vacante:e.target.checked}),type:"checkbox",className:"mr-2"}),"Vacante"]}),a.jsxs("div",{className:"flex gap-2",children:[a.jsx("button",{type:"submit",className:"px-4 py-2 bg-green-600 text-white rounded",children:"Guardar raíz"}),a.jsx("button",{type:"button",onClick:()=>w(!1),className:"px-4 py-2 border rounded",children:"Cancelar"})]})]}):a.jsxs("div",{className:"space-y-4",children:[a.jsx("h2",{className:"text-xl font-bold",children:"Organigrama vacío"}),a.jsx("p",{children:"No hay nodos creados todavía. Crea el nodo principal (raíz) para comenzar."}),a.jsxs("div",{className:"flex gap-2",children:[a.jsx("button",{onClick:()=>w(!0),className:"px-4 py-2 bg-blue-600 text-white rounded",children:"Crear nodo raíz"}),a.jsx("button",{onClick:async()=>{if(confirm("Crear nodos desde todos los users que no tengan?"))try{await i.post("/admin/organigrama/generate-from-users"),await d()}catch(e){console.error(e),alert("Error generando desde users.")}},className:"px-4 py-2 border rounded",children:"Generar desde users"})]})]})}):a.jsx("div",{className:"w-full h-full overflow-auto",children:a.jsx(H,{data:f,translate:O(),orientation:"vertical",pathFunc:"elbow",zoomable:!0,collapsible:!0,onNodeClick:(e,r)=>_(e),renderCustomNodeElement:e=>L(e),allowForeignObjects:!0})})})}),F&&n&&a.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50",children:a.jsxs("div",{className:"bg-white dark:bg-gray-900 rounded-2xl w-11/12 sm:w-96 max-h-[90vh] p-6 shadow-lg relative overflow-auto",children:[a.jsx("button",{onClick:()=>j(!1),className:"absolute top-3 right-3 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300",children:"✕"}),a.jsx("h3",{className:"text-lg font-bold mb-3",children:"Detalles"}),a.jsxs("div",{className:"space-y-3",children:[a.jsxs("div",{children:[a.jsxs("div",{className:"text-sm text-gray-500 dark:text-gray-400",children:["ID: ",n.id]}),a.jsx("div",{className:"text-xl font-semibold text-gray-900 dark:text-gray-100",children:n.name}),a.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-300",children:n.title}),a.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:["Legajo: ",n.legajo??"-"]})]}),a.jsxs("form",{onSubmit:V,className:"border-t pt-2 space-y-2",children:[a.jsx("h4",{className:"font-medium",children:"Editar / Asignar usuario"}),a.jsx("label",{className:"block text-xs",children:"Asignar usuario"}),a.jsxs("select",{value:t.legajo,onChange:e=>b({...t,legajo:e.target.value,vacante:!e.target.value}),className:"border p-2 rounded w-full",children:[a.jsx("option",{value:"",children:"-- Dejar vacante --"}),[n.user,...N].filter(Boolean).map(e=>a.jsxs("option",{value:e.legajo,children:[e.nombre," (",e.legajo,")"]},e.legajo))]}),a.jsx("label",{className:"block text-xs",children:"Banda"}),a.jsx("input",{className:"border p-2 rounded w-full",value:t.banda,onChange:e=>b({...t,banda:e.target.value})}),a.jsx("label",{className:"block text-xs",children:"Nivel"}),a.jsx("input",{type:"number",className:"border p-2 rounded w-full",value:t.nivel_jerarquico,onChange:e=>b({...t,nivel_jerarquico:Number(e.target.value)})}),a.jsxs("label",{className:"inline-flex items-center",children:[a.jsx("input",{type:"checkbox",className:"mr-2",checked:t.vacante,onChange:e=>b({...t,vacante:e.target.checked})}),"Vacante"]}),a.jsxs("div",{className:"flex gap-2 mt-2",children:[a.jsx("button",{type:"submit",className:"px-3 py-1 bg-green-600 text-white rounded",children:"Guardar"}),a.jsx("button",{type:"button",onClick:$,className:"px-3 py-1 bg-red-600 text-white rounded",children:"Eliminar"}),a.jsx("button",{type:"button",onClick:()=>j(!1),className:"px-3 py-1 border rounded",children:"Cerrar"})]})]}),a.jsxs("div",{className:"border-t pt-2",children:[a.jsx("h4",{className:"font-medium",children:"Crear hijo"}),a.jsx("label",{className:"block text-xs mt-2",children:"Asignar usuario"}),a.jsxs("select",{value:l.legajo,onChange:e=>m({...l,legajo:e.target.value}),className:"border p-2 rounded w-full",children:[a.jsx("option",{value:"",children:"-- Vacante --"}),N.map(e=>a.jsxs("option",{value:e.legajo,children:[e.nombre," (",e.legajo,")"]},e.legajo))]}),a.jsx("label",{className:"block text-xs mt-2",children:"Banda"}),a.jsx("input",{className:"border p-2 rounded w-full",value:l.banda,onChange:e=>m({...l,banda:e.target.value})}),a.jsx("label",{className:"block text-xs mt-2",children:"Nivel"}),a.jsx("input",{type:"number",className:"border p-2 rounded w-full",value:l.nivel_jerarquico,onChange:e=>m({...l,nivel_jerarquico:Number(e.target.value)})}),a.jsxs("label",{className:"inline-flex items-center mt-2",children:[a.jsx("input",{type:"checkbox",className:"mr-2",checked:l.vacante,onChange:e=>m({...l,vacante:e.target.checked})}),"Vacante"]}),a.jsx("div",{className:"mt-3",children:a.jsx("button",{onClick:B,className:"px-3 py-1 bg-blue-600 text-white rounded",children:"Crear hijo"})})]})]})]})})]})]})};export{J as default};
